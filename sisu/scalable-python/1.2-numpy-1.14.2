#%Module1.0
##
## Scalable Python modulefile
##
proc ModulesHelp { } {
  global scapy_version
  global pyversion

  puts stderr "\tScalable Python environment built with GNU compilers."
  puts stderr "\tVersion:  $scapy_version (based on Python $pyversion)"
  puts stderr "\tModifies: LD_LIBRARY_PATH, MANPATH, PATH, PYTHONPATH"
  puts stderr "\tSets:     PYTHONUSERBASE\n"
}

# define software versions and basedir
set prog_root       "/appl/opt/python/scalable-python-2018-04"
set scapy_version   "1.2"
set pyversion       "2.7.13"
set python_bundle   "2018-03"
set numpy_version   "1.14.2"
set scipy_version   "1.0.1"
set cython_version  "0.29"
set mpi4py_version  "3.0.0"
set ase_version     "3.16.0"

# ensure that no other Python module is loaded
conflict python
conflict scalable-python

# switch PrgEnv to gnu if necessary
set confl_prgenvs [list "PrgEnv-intel" "PrgEnv-cray"]
foreach prgenv $confl_prgenvs {
  if { [ is-loaded $prgenv] } {
    module switch $prgenv PrgEnv-gnu
  }
}

# print some information when loading
if { [ module-info mode load ] } {
  if { [ is-loaded "ase" ] } {
    puts stderr ""
    puts stderr "\tUnloading previously loaded module: ase"
    module unload ase
  }
  puts stderr ""
  puts stderr "\tLoading Scalable Python (v$scapy_version)."
  puts stderr "\t  Modules included:"
  puts stderr "\t  numpy ($numpy_version), scipy ($scipy_version), ase ($ase_version),"
  puts stderr "\t  mpi4py ($mpi4py_version), cython ($cython_version)" 
  puts stderr ""
  puts stderr "\tNote: Programming environment is now PrgEnv-gnu"
  puts stderr ""
}

# whatis information
module-whatis "Load Scalable Python environment"
module-whatis "Version:  $scapy_version (based on Python $pyversion)"
module-whatis "Modifies: LD_LIBRARY_PATH, MANPATH, PATH, PYTHONPATH"
module-whatis "Sets:     PYTHONHOME, PYTHONUSERBASE"

# set environmental variables
prepend-path  PATH             "$prog_root/bin"
prepend-path  MANPATH          "$prog_root/share/man"
prepend-path  LD_LIBRARY_PATH  "$prog_root/lib"
prepend-path  LD_LIBRARY_PATH  "/appl/opt/libressl/2.6.4/lib"
setenv        PYTHONHOME       "$prog_root"
setenv        PYTHONUSERBASE   "$prog_root/bundle/$python_bundle"
prepend-path  PATH             "$prog_root/bundle/$python_bundle/bin"

